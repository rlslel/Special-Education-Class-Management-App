import React, { useState, useEffect, useRef, useMemo } from 'react';
import { 
  Camera, Save, X, User, Plus, Lock, Calendar, GraduationCap, Image, Settings, Home, 
  Trash2, Heart, Key, MessageCircle, Send, BookOpen, Check, Users, Briefcase, 
  Wand2, CheckSquare, AlertCircle, HelpCircle, RefreshCcw, ChevronDown, ChevronUp, 
  Edit2, Download, Upload, Database, Briefcase as Case, AlertTriangle, Ban, RotateCcw, 
  Link as LinkIcon, Book, Coins, Clock
} from 'lucide-react';

// =================================================================================
// [1] ì „ì—­ ìƒìˆ˜ ë° ì„¤ì •
// =================================================================================

const TARGET_SUBJECTS = ['ğŸ“• êµ­ì–´', 'ğŸ“ ìˆ˜í•™', 'ğŸŒ ì‚¬íšŒ', 'âš—ï¸ ê³¼í•™', 'âš–ï¸ ë„ë•', 'ğŸ…°ï¸ ì˜ì–´', 'ğŸƒ ì²´ìœ¡', 'ğŸµ ìŒì•…', 'ğŸ¨ ë¯¸ìˆ ', 'ğŸ’» ì‹¤ê³¼', 'ğŸ³ ìš”ë¦¬', 'âœ¨ íŠ¹ìƒ‰'];
const DEFAULT_AVATARS = Array.from({ length: 6 }, (_, i) => `/default-avatars/avatar${i + 1}.png`);
const SECURITY_QUESTIONS = ['ë³´ë¬¼ 1í˜¸ëŠ”?', 'ì¶”ì–µì˜ ì¥ì†ŒëŠ”?', 'ì¢‹ì•„í•˜ëŠ” ìŒì‹ì€?', 'ì§ì ‘ ì…ë ¥'];
const STORAGE_KEYS = ['app_password', 'app_security', 'students_data', 'staff_data', 'integrated_schedule', 'class_photos', 'teacher_todos', 'service_records', 'budget_definitions', 'grade_timetables'];

// í•™ìƒë³„ ê³ ìœ  ìƒ‰ìƒ íŒ”ë ˆíŠ¸ (íŒŒìŠ¤í…”í†¤)
const STUDENT_COLORS = [
  'bg-red-100 border-red-200 text-red-800', 'bg-orange-100 border-orange-200 text-orange-800',
  'bg-amber-100 border-amber-200 text-amber-800', 'bg-green-100 border-green-200 text-green-800',
  'bg-emerald-100 border-emerald-200 text-emerald-800', 'bg-teal-100 border-teal-200 text-teal-800',
  'bg-cyan-100 border-cyan-200 text-cyan-800', 'bg-blue-100 border-blue-200 text-blue-800',
  'bg-indigo-100 border-indigo-200 text-indigo-800', 'bg-violet-100 border-violet-200 text-violet-800',
  'bg-purple-100 border-purple-200 text-purple-800', 'bg-fuchsia-100 border-fuchsia-200 text-fuchsia-800',
  'bg-pink-100 border-pink-200 text-pink-800', 'bg-rose-100 border-rose-200 text-rose-800'
];

const getStudentColor = (id) => STUDENT_COLORS[id % STUDENT_COLORS.length] || STUDENT_COLORS[0];

const usePersistentState = (key, initialValue) => {
  const [state, setState] = useState(() => {
    try {
      const saved = localStorage.getItem(key);
      return saved ? JSON.parse(saved) : initialValue;
    } catch { return initialValue; }
  });
  useEffect(() => localStorage.setItem(key, JSON.stringify(state)), [key, state]);
  return [state, setState];
}

// =================================================================================
// [2] UI ì»´í¬ë„ŒíŠ¸
// =================================================================================

const UI = {
  Btn: ({ children, onClick, className = "", variant = "primary", ...props }) => {
    const base = "py-3 rounded-xl font-bold transition-all active:scale-95 flex items-center justify-center gap-2";
    const variants = {
      primary: "bg-pink-400 hover:bg-pink-500 text-white shadow-md",
      secondary: "bg-gray-100 hover:bg-gray-200 text-gray-600",
      blue: "bg-blue-500 hover:bg-blue-600 text-white shadow-md",
      danger: "bg-red-50 hover:bg-red-100 text-red-500",
      ghost: "bg-transparent hover:bg-gray-50 text-gray-500"
    };
    return <button onClick={onClick} className={`${base} ${variants[variant]} ${className}`} {...props}>{children}</button>;
  },
  Input: ({ label, className = "", ...props }) => (
    <div className="w-full">
      {label && <label className="block text-xs font-bold text-gray-400 mb-1 ml-1">{label}</label>}
      <input className={`w-full p-3 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-pink-200 ${className}`} {...props} />
    </div>
  ),
  Select: ({ label, options, ...props }) => (
    <div className="w-full">
      {label && <label className="block text-xs font-bold text-gray-400 mb-1 ml-1">{label}</label>}
      <select className="w-full p-3 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-pink-200" {...props}>
        {options.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
      </select>
    </div>
  ),
  Modal: ({ children, onClose, title, maxWidth = "max-w-2xl" }) => {
    useEffect(() => {
      const handleEsc = (e) => e.key === 'Escape' && onClose();
      window.addEventListener('keydown', handleEsc);
      return () => window.removeEventListener('keydown', handleEsc);
    }, [onClose]);
    return (
      <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in-up" onClick={onClose}>
        <div className={`bg-white rounded-[2rem] shadow-2xl w-full ${maxWidth} overflow-hidden max-h-[90vh] flex flex-col`} onClick={e => e.stopPropagation()}>
          {title && <div className="p-4 border-b flex justify-between items-center bg-white sticky top-0 z-10"><h3 className="text-xl font-bold ml-2">{title}</h3><button onClick={onClose}><X size={20}/></button></div>}
          {children}
        </div>
      </div>
    );
  },
  Card: ({ icon, title, value, color }) => {
    const colors = { pink: 'bg-pink-100 text-pink-600', blue: 'bg-sky-100 text-sky-600', purple: 'bg-purple-100 text-purple-600' };
    return (
      <div className="bg-white p-6 rounded-[2rem] shadow-lg flex items-center gap-6 hover:-translate-y-1 transition-transform cursor-pointer border border-gray-50">
        <div className={`w-20 h-20 rounded-2xl flex items-center justify-center text-4xl ${colors[color]}`}>{icon}</div>
        <div><h3 className="text-gray-400 font-bold text-sm mb-1">{title}</h3><p className="text-3xl font-extrabold text-gray-800">{value}</p></div>
      </div>
    );
  }
};

const ConfirmModal = ({ isOpen, message, onConfirm, onCancel }) => !isOpen ? null : (
  <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div className="bg-white rounded-2xl shadow-2xl p-6 w-80 text-center animate-bounce-short">
      <AlertTriangle size={24} className="text-red-500 mx-auto mb-4"/>
      <h3 className="text-lg font-bold text-gray-800 mb-2">í™•ì¸</h3><p className="text-gray-600 text-sm mb-6">{message}</p>
      <div className="flex gap-2"><UI.Btn variant="secondary" className="flex-1" onClick={onCancel}>ì·¨ì†Œ</UI.Btn><UI.Btn variant="danger" className="flex-1" onClick={onConfirm}>í™•ì¸</UI.Btn></div>
    </div>
  </div>
);

// =================================================================================
// [3] ë©”ì¸ ì•±
// =================================================================================

export default function App() {
  const [auth, setAuth] = useState({ authenticated: false, setupMode: false });
  const [pwInput, setPwInput] = useState('');
  const [storedPw, setStoredPw] = usePersistentState('app_password', null);
  const [security, setSecurity] = usePersistentState('app_security', null);
  const [modal, setModal] = useState({ type: null, msg: '' }); 
  const [setup, setSetup] = useState({ pw: '', q: SECURITY_QUESTIONS[0], a: '', customQ: '' });

  useEffect(() => { if (!storedPw) setAuth(p => ({ ...p, setupMode: true })); }, [storedPw]);

  const handleAuth = () => {
    if (auth.setupMode) {
      if (setup.pw.length < 4) return setModal({ type: 'error', msg: 'ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬ ì´ìƒ' });
      if (!setup.a.trim()) return setModal({ type: 'error', msg: 'ë‹µë³€ ì…ë ¥ í•„ìˆ˜' });
      setStoredPw(setup.pw);
      setSecurity({ question: setup.q === 'ì§ì ‘ ì…ë ¥' ? setup.customQ : setup.q, answer: setup.a });
      setAuth({ setupMode: false, authenticated: true });
    } else {
      if (pwInput === storedPw) setAuth({ ...auth, authenticated: true });
      else { setModal({ type: 'error', msg: 'ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜' }); setPwInput(''); }
    }
  };

  if (!auth.authenticated) return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-100 via-purple-100 to-pink-100 p-4">
      <div className="bg-white p-8 rounded-[2rem] shadow-xl w-full max-w-md text-center animate-fade-in-up">
        <div className="flex justify-center mb-6"><div className="w-24 h-24 bg-yellow-200 rounded-full flex items-center justify-center text-4xl shadow-inner">ğŸŒŸ</div></div>
        <h1 className="text-2xl font-extrabold text-gray-700 mb-2">{auth.setupMode ? 'í™˜ì˜í•©ë‹ˆë‹¤!' : 'ì„ ìƒë‹˜, ì•ˆë…•í•˜ì„¸ìš”!'}</h1>
        {auth.setupMode ? (
          <div className="space-y-4 text-left">
            <UI.Input label="ë¹„ë°€ë²ˆí˜¸ ì„¤ì •" type="password" value={setup.pw} onChange={e => setSetup({...setup, pw: e.target.value})} />
            <UI.Select label="ë³¸ì¸ í™•ì¸ ì§ˆë¬¸" options={SECURITY_QUESTIONS.map(q => ({ value: q, label: q }))} value={setup.q} onChange={e => setSetup({...setup, q: e.target.value})} />
            {setup.q === 'ì§ì ‘ ì…ë ¥' && <UI.Input className="mt-2" value={setup.customQ} onChange={e => setSetup({...setup, customQ: e.target.value})} placeholder="ì§ˆë¬¸ ì…ë ¥" />}
            <UI.Input className="mt-2" value={setup.a} onChange={e => setSetup({...setup, a: e.target.value})} placeholder="ì •ë‹µ ì…ë ¥" />
            <UI.Btn className="w-full mt-2" onClick={handleAuth}>ì‹œì‘í•˜ê¸°</UI.Btn>
          </div>
        ) : (
          <><div className="relative mb-4"><UI.Input type="password" value={pwInput} onChange={e => setPwInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && handleAuth()} placeholder="â€¢â€¢â€¢â€¢" className="text-center text-xl tracking-[0.5em]" /><Lock size={20} className="absolute top-9 right-4 text-gray-300"/></div><UI.Btn className="w-full" onClick={handleAuth}>ë¡œê·¸ì¸</UI.Btn><button onClick={() => setModal({ type: 'recovery' })} className="mt-4 text-xs text-gray-400 underline">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</button></>
        )}
      </div>
      {modal.type === 'error' && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/30" onClick={() => setModal({ type: null })}><div className="bg-white p-6 rounded-3xl w-80 text-center"><AlertCircle size={48} className="text-red-400 mx-auto mb-4" /><p className="text-gray-500 mb-6">{modal.msg}</p><UI.Btn className="w-full bg-gray-800" onClick={() => setModal({ type: null })}>í™•ì¸</UI.Btn></div></div>}
      {modal.type === 'recovery' && <RecoveryModal securityData={security} onClose={() => setModal({ type: null })} onSuccess={p=>{setStoredPw(p); setModal({type:'error', msg:'ì¬ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.'})}} onError={msg => setModal({ type: 'error', msg })} />}
    </div>
  );

  return <MainLayout storedPw={storedPw} security={security} showGlobalError={msg => setModal({ type: 'error', msg })} />;
}

// =================================================================================
// [4] ë ˆì´ì•„ì›ƒ
// =================================================================================

function MainLayout({ storedPw, showGlobalError }) {
  const [menu, setMenu] = useState('dashboard');
  const [students, setStudents] = usePersistentState('students_data', []);
  const [staff, setStaff] = usePersistentState('staff_data', []);
  const [secCheck, setSecCheck] = useState({ open: false, target: null, input: '' });

  const MENU_ITEMS = [
    { id: 'dashboard', label: 'ëŒ€ì‹œë³´ë“œ', icon: Home },
    { id: 'students', label: 'í•™ìƒê´€ë¦¬', icon: User, protected: true },
    { id: 'personnel', label: 'ì§€ì›ì¸ë ¥', icon: Users, protected: true },
    { id: 'budget', label: 'ì˜ˆì‚°', icon: Coins, protected: true },
    { id: 'schedule', label: 'ì‹œê°„í‘œ', icon: Calendar },
    { id: 'education', label: 'ê°œë³„í™”êµìœ¡', icon: GraduationCap, protected: true },
    { id: 'photos', label: 'í™œë™ì‚¬ì§„', icon: Image },
    { id: 'settings', label: 'ì„¤ì •', icon: Settings, protected: true },
  ];

  const navigate = (id, isProtected) => {
    if (menu === id) return;
    if (isProtected) setSecCheck({ open: true, target: id, input: '' });
    else setMenu(id);
  };

  const verify = (e) => {
    e.preventDefault();
    if (secCheck.input === storedPw) {
      setMenu(secCheck.target);
      setSecCheck({ ...secCheck, open: false });
    } else showGlobalError('ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜');
  };

  const commonProps = { students, setStudents, staff, setStaff, showGlobalError };
  const Page = { 
    dashboard: Dashboard, students: StudentManager, personnel: PersonnelManager, 
    budget: BudgetManager, schedule: ScheduleManager, education: EducationManager, 
    photos: PhotoManager, settings: SettingsPage 
  }[menu] || Dashboard;

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 flex font-sans text-gray-700">
      <aside className="w-20 bg-white/80 backdrop-blur-md border-r border-white shadow-xl flex flex-col z-10 items-center py-6 shrink-0">
        <div className="mb-8 w-12 h-12 bg-yellow-300 rounded-full flex items-center justify-center text-2xl shadow-lg">ğŸš€</div>
        <nav className="flex-1 w-full space-y-4 px-2">
          {MENU_ITEMS.map(({ id, label, icon: Icon, protected: isProtected }) => (
            <button key={id} onClick={() => navigate(id, isProtected)} className={`w-full flex flex-col items-center py-3 rounded-2xl transition-all relative ${menu === id ? 'bg-gradient-to-br from-pink-400 to-rose-400 text-white shadow-lg' : 'text-gray-400 hover:bg-white'}`}>
              <Icon size={24} className={menu === id ? 'text-white' : 'group-hover:text-pink-400'} />
              <span className={`text-[10px] mt-1 font-bold ${menu === id ? 'text-white' : 'text-gray-400 group-hover:text-pink-400'}`}>{label}</span>
              {isProtected && menu !== id && <Lock size={10} className="absolute top-1 right-2 text-gray-300" />}
            </button>
          ))}
        </nav>
      </aside>
      <main className="flex-1 overflow-y-auto relative">{menu === 'settings' ? <SettingsPage storedPw={storedPw} showGlobalError={showGlobalError}/> : <Page {...commonProps} />}</main>
      {secCheck.open && <UI.Modal onClose={() => setSecCheck({ ...secCheck, open: false })} maxWidth="max-w-sm"><div className="p-6 text-center"><Lock size={40} className="mx-auto text-gray-300 mb-4"/><h3 className="text-xl font-bold mb-4">ë³´ì•ˆ ì ‘ê·¼ í™•ì¸</h3><form onSubmit={verify}><UI.Input type="password" autoFocus value={secCheck.input} onChange={e => setSecCheck({...secCheck, input: e.target.value})} className="mb-4 text-center text-lg tracking-widest" placeholder="â€¢â€¢â€¢â€¢" /><div className="flex gap-2"><UI.Btn type="button" variant="secondary" className="flex-1" onClick={() => setSecCheck({ ...secCheck, open: false })}>ì·¨ì†Œ</UI.Btn><UI.Btn type="submit" className="flex-1">í™•ì¸</UI.Btn></div></form></div></UI.Modal>}
    </div>
  );
}

// =================================================================================
// [5] ëŒ€ì‹œë³´ë“œ
// =================================================================================

function Dashboard({ students, staff }) {
  const [todoOpen, setTodoOpen] = useState(false);
  const getAssignedStaffName = (sid) => staff.filter(s => s.assignedStudentIds?.includes(sid)).map(s => s.name).join(', ');

  return (
    <div className="p-8 max-w-6xl mx-auto">
      <h2 className="text-3xl font-extrabold text-gray-800 mb-10">ì˜¤ëŠ˜ì˜ í•™ê¸‰ í˜„í™©</h2>
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
        <UI.Card icon={<Users/>} title="ë“±ë¡ í•™ìƒ" value={`${students.length}ëª…`} color="pink" />
        <div onClick={() => setTodoOpen(true)}><UI.Card icon={<Calendar/>} title="ì˜¤ëŠ˜ì˜ ì¼ì •" value="í™•ì¸í•˜ê¸°" color="blue" /></div>
        <UI.Card icon={<Image/>} title="ìƒˆ í™œë™ ì‚¬ì§„" value="ì•¨ë²”ë³´ê¸°" color="purple" />
      </div>
      <div className="bg-white p-8 rounded-[2rem] shadow-xl border border-white">
        <h3 className="text-xl font-bold text-gray-800 mb-6">ìš°ë¦¬ ë°˜ ì•„ì´ë“¤</h3>
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          {students.length > 0 ? students.map(s => (
            <div key={s.id} className="flex items-center gap-4 p-4 rounded-2xl bg-gray-50 border border-gray-100 hover:shadow-md transition-all">
               <img src={s.photo} className="w-14 h-14 rounded-full object-cover border bg-white flex-shrink-0"/>
               <div className="flex-1 min-w-0">
                  <p className="font-bold text-gray-800 text-lg truncate">{s.name}</p>
                  <p className="text-xs text-gray-500 truncate">{s.grade}í•™ë…„ {s.classNumber}ë°˜</p>
                  {getAssignedStaffName(s.id) && <div className="mt-1 flex items-center gap-1 text-[10px] text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full w-fit"><Briefcase size={10} /> ë‹´ë‹¹: {getAssignedStaffName(s.id)}</div>}
               </div>
            </div>
          )) : <div className="col-span-full text-center py-10 text-gray-400">í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>}
        </div>
      </div>
      {todoOpen && <TodoListModal onClose={() => setTodoOpen(false)} />}
    </div>
  );
}

// =================================================================================
// [6] í•™ìƒ ê´€ë¦¬ (ì¤‘ì¦ë„ ì¶”ê°€)
// =================================================================================

function StudentManager({ students, setStudents }) {
  const [modal, setModal] = useState(null); 
  const [confirmModal, setConfirmModal] = useState({ open: false, id: null });
   
  const save = (data) => {
    const updated = modal.type === 'add' 
      ? [...students, { ...data, id: Date.now(), photo: DEFAULT_AVATARS[students.length % 6] }] 
      : students.map(s => s.id === data.id ? data : s);
    setStudents(updated);
    setModal({ type: 'success' });
  };

  return (
    <div className="p-8 max-w-7xl mx-auto">
      <div className="flex justify-between items-center mb-8"><h2 className="text-3xl font-extrabold text-gray-800">í•™ìƒ ê´€ë¦¬</h2><UI.Btn onClick={() => setModal({ type: 'add' })} className="bg-gray-800 px-6 rounded-full"><Plus size={20}/> í•™ìƒ ë“±ë¡</UI.Btn></div>
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
        {students.map(s => (
          <div key={s.id} onClick={() => setModal({ type: 'edit', data: s })} className={`cursor-pointer rounded-3xl border-4 ${getStudentColor(s.id)} bg-white shadow-lg hover:-translate-y-2 transition-all overflow-hidden`}>
            <div className="p-6 flex flex-col items-center">
              <div className="w-32 h-32 rounded-full border-4 border-white shadow-md overflow-hidden bg-gray-100 mb-4 flex items-center justify-center"><img src={s.photo} className="w-full h-full object-cover"/></div>
              <div className="px-4 py-1 rounded-full mb-4 bg-white/50 border"><h2 className="text-xl font-bold text-gray-800">{s.name}</h2></div>
              <div className="w-full text-sm text-gray-600 space-y-1"><div className="flex justify-between"><span>í•™ë…„/ë°˜</span><b>{s.grade}í•™ë…„ {s.classNumber}ë°˜</b></div><div className="flex justify-between"><span>ì¤‘ì¦ë„</span><b>{s.severity || '-'}ìˆœìœ„</b></div></div>
            </div>
          </div>
        ))}
      </div>
      {modal && modal.type !== 'success' && <StudentModal student={modal.data} onClose={() => setModal(null)} onSave={save} onDelete={(id) => setConfirmModal({ open: true, id })} isEdit={modal.type === 'edit'} />}
      {modal && modal.type === 'success' && <UI.Modal onClose={() => setModal(null)} maxWidth="max-w-sm"><div className="p-8 text-center"><Check size={48} className="text-green-500 mx-auto mb-4"/><h3 className="text-xl font-bold mb-6">ì €ì¥ ì™„ë£Œ!</h3><UI.Btn className="w-full bg-green-500" onClick={() => setModal(null)}>í™•ì¸</UI.Btn></div></UI.Modal>}
      <ConfirmModal isOpen={confirmModal.open} message="ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?" onConfirm={()=>{setStudents(students.filter(s=>s.id!==confirmModal.id)); setConfirmModal({open:false})}} onCancel={()=>setConfirmModal({open:false})} />
    </div>
  );
}

function StudentModal({ student, onClose, onSave, onDelete, isEdit }) {
  const [form, setForm] = useState(student || { name: '', grade: '1', classNumber: '', severity: '3', teacher: '', extension: '', targetSubjects: [] });
  const fileRef = useRef();
  const handlePhoto = (e) => { const f = e.target.files[0]; if(f) { const r = new FileReader(); r.onloadend = () => setForm(p => ({...p, photo: r.result})); r.readAsDataURL(f); }};
  const toggleSub = (s) => setForm(p => ({...p, targetSubjects: p.targetSubjects.includes(s) ? p.targetSubjects.filter(i => i !== s) : [...p.targetSubjects, s]}));

  return (
    <UI.Modal onClose={onClose} maxWidth="max-w-2xl">
      <div className="p-6 bg-gray-50 flex flex-col items-center relative">
        <button onClick={onClose} className="absolute top-4 right-4"><X size={20}/></button>
        {isEdit && <button onClick={() => onDelete(form.id)} className="absolute top-4 left-4 text-red-500"><Trash2 size={20}/></button>}
        <div className="relative group w-32 h-32 rounded-full border-4 border-white shadow-lg overflow-hidden bg-white mb-4" onClick={()=>fileRef.current.click()}>
          <img src={form.photo} className="w-full h-full object-cover"/>
          <div className="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 cursor-pointer"><Camera className="text-white"/></div>
          <input type="file" ref={fileRef} onChange={handlePhoto} className="hidden" accept="image/*"/>
        </div>
        <input value={form.name} onChange={e => setForm({...form, name: e.target.value})} className="text-3xl font-extrabold bg-transparent text-center outline-none w-40" placeholder="ì´ë¦„" />
      </div>
      <div className="p-8 h-[50vh] overflow-y-auto custom-scrollbar space-y-6">
        <div className="grid grid-cols-2 gap-6">
          <div className="space-y-3">
            <div className="flex gap-2">
                <UI.Select label="í•™ë…„" value={form.grade} onChange={e => setForm({...form, grade: e.target.value})} options={[1,2,3,4,5,6].map(g => ({value: g, label: `${g}í•™ë…„`}))} />
                <UI.Input label="ë°˜" value={form.classNumber} onChange={e => setForm({...form, classNumber: e.target.value})} />
            </div>
            <UI.Input label="ì¤‘ì¦ë„ ìˆœìœ„ (1~3)" type="number" min="1" max="3" value={form.severity} onChange={e => setForm({...form, severity: e.target.value})} placeholder="ìˆ«ìë§Œ ì…ë ¥" />
            <UI.Input label="ë‹´ì„ ì„ ìƒë‹˜" value={form.teacher} onChange={e => setForm({...form, teacher: e.target.value})} />
          </div>
          <div className="space-y-3">
            <UI.Input label="ìƒë…„ì›”ì¼" type="date" value={form.birthDate} onChange={e => setForm({...form, birthDate: e.target.value})} />
            <UI.Select label="ì¥ì•  ì˜ì—­" value={form.disabilityType} onChange={e => setForm({...form, disabilityType: e.target.value})} options={['ì§€ì ì¥ì• ', 'ìíì„±ì¥ì• ', 'ì‹œê°ì¥ì• ', 'ì²­ê°ì¥ì• ', 'ì§€ì²´ì¥ì• ', 'ë°œë‹¬ì§€ì²´', 'ì •ì„œí–‰ë™ì¥ì• ', 'ê¸°íƒ€'].map(v => ({value: v, label: v}))} />
          </div>
        </div>
        <div>
          <h3 className="font-bold text-gray-400 border-b pb-2 mb-2 flex items-center gap-2"><BookOpen size={16}/> ëŒ€ìƒ ê³¼ëª©</h3>
          <div className="flex flex-wrap gap-2">{TARGET_SUBJECTS.map(s => <button key={s} onClick={() => toggleSub(s)} className={`px-3 py-1 rounded-full text-sm font-bold transition-all ${form.targetSubjects.includes(s) ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-400'}`}>{s}</button>)}</div>
        </div>
        <div className="grid grid-cols-2 gap-4">
            <textarea value={form.dreamCardUsage} onChange={e => setForm({...form, dreamCardUsage: e.target.value})} className="p-3 bg-yellow-50 border-yellow-100 border rounded-xl h-20 text-sm resize-none" placeholder="ê¿ˆê¾¸ë¯¸ ì¹´ë“œ ë©”ëª¨" />
            <textarea value={form.jaramiCardUsage} onChange={e => setForm({...form, jaramiCardUsage: e.target.value})} className="p-3 bg-green-50 border-green-100 border rounded-xl h-20 text-sm resize-none" placeholder="ìë¼ë¯¸ ì¹´ë“œ ë©”ëª¨" />
        </div>
      </div>
      <div className="p-4 border-t flex justify-end"><UI.Btn onClick={() => onSave(form)} className="px-8 bg-gray-800">ì €ì¥í•˜ê¸°</UI.Btn></div>
    </UI.Modal>
  );
}

// =================================================================================
// [7] ì¸ë ¥ ê´€ë¦¬
// =================================================================================

function PersonnelManager({ students, staff, setStaff }) {
  const [recs, setRecs] = usePersistentState('service_records', []); 
  const [modal, setModal] = useState(null);
  const [serviceModal, setServiceModal] = useState(null); 
  const [confirmModal, setConfirmModal] = useState({ open: false, id: null });

  const saveStaff = (d) => {
      setStaff(modal.mode === 'add' ? [...staff, { ...d, id: Date.now(), role: modal.type==='practical'?'ì‹¤ë¬´ì‚¬':'ì‚¬íšŒë³µë¬´', type: modal.type }] : staff.map(s => s.id === d.id ? { ...s, ...d } : s));
      setModal(null);
  };
  const addRec = (e) => { e.preventDefault(); setRecs([...recs, { id:Date.now(), ...serviceModal, type:e.target.type.value, date:e.target.date.value, desc:e.target.desc.value }]); setServiceModal(null); };
  
  const StaffList = ({ type, title, color }) => (
    <div className="flex-1 flex flex-col">
      <div className={`p-4 rounded-t-2xl border-b-2 flex justify-between items-center bg-${color}-100 border-${color}-200 text-${color}-800`}>
        <h3 className="font-extrabold flex gap-2"><Users size={20}/> {title}</h3><button onClick={()=>setModal({ type, mode: 'add', data: {} })} className="bg-white/50 p-2 rounded-full hover:bg-white"><Plus size={18}/></button>
      </div>
      <div className="bg-white p-4 rounded-b-2xl shadow-lg border-t-0 space-y-3 min-h-[200px]">
        {staff.filter(s=>s.type===type).map(s => (
          <div key={s.id} onClick={() => setModal({ type, mode: 'edit', data: s })} className={`cursor-pointer p-3 rounded-xl border flex justify-between items-center hover:-translate-y-1 transition-transform bg-${color}-50 border-${color}-200`}>
            <div className="flex items-center gap-3"><div className="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm">ğŸ‘¤</div><div><div className="font-bold">{s.name}</div>{s.assignedStudentIds?.length > 0 && <div className="text-[10px] text-gray-500 mt-1">ë‹´ë‹¹: {s.assignedStudentIds.map(id => students.find(s => s.id === id)?.name).join(', ')}</div>}</div></div>
            <button onClick={(e) => { e.stopPropagation(); setConfirmModal({open: true, id: s.id}); }} className="text-red-400 p-2"><Trash2 size={16}/></button>
          </div>
        ))}
      </div>
    </div>
  );

  return (
    <div className="p-8 h-full flex flex-col overflow-y-auto">
      <h2 className="text-3xl font-extrabold text-gray-800 mb-8">ì§€ì›ì¸ë ¥ ê´€ë¦¬</h2>
      <div className="flex flex-col md:flex-row gap-6 max-w-6xl mb-8"><StaffList type="practical" title="íŠ¹ìˆ˜êµìœ¡ ì‹¤ë¬´ì‚¬" color="blue"/><StaffList type="social" title="ì‚¬íšŒë³µë¬´ìš”ì›" color="green"/></div>
      {modal && <UI.Modal onClose={()=>setModal(null)} title={`${modal.type==='practical'?'ì‹¤ë¬´ì‚¬':'ì‚¬íšŒë³µë¬´'} ${modal.mode==='add'?'ë“±ë¡':'ìˆ˜ì •'}`} maxWidth="max-w-md">
        <form onSubmit={e=>{e.preventDefault(); saveStaff(modal.data);}} className="p-6">
            <UI.Input label="ì´ë¦„" value={modal.data.name||''} onChange={e=>setModal({...modal, data:{...modal.data, name:e.target.value}})} required className="mb-6"/>
            <div className="mb-6"><label className="text-xs font-bold text-gray-400">ì „ë‹´ ì§€ì› í•™ìƒ</label><div className="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto p-1">{students.map(s=><div key={s.id} onClick={()=>{const ids=modal.data.assignedStudentIds||[]; setModal({...modal, data:{...modal.data, assignedStudentIds:ids.includes(s.id)?ids.filter(i=>i!==s.id):[...ids,s.id]}})}} className={`p-2 rounded-lg border cursor-pointer flex items-center gap-2 ${modal.data.assignedStudentIds?.includes(s.id)?'bg-blue-50 border-blue-400 text-blue-700':'bg-white'}`}><div className={`w-4 h-4 rounded border flex items-center justify-center ${modal.data.assignedStudentIds?.includes(s.id)?'bg-blue-500 border-blue-500':''}`}>{modal.data.assignedStudentIds?.includes(s.id)&&<Check size={12} className="text-white"/>}</div><span className="text-sm font-bold">{s.name}</span></div>)}</div></div>
            <div className="flex gap-2"><UI.Btn type="button" variant="secondary" className="flex-1" onClick={()=>setModal(null)}>ì·¨ì†Œ</UI.Btn><UI.Btn type="submit" variant="blue" className="flex-1">ì €ì¥</UI.Btn></div>
        </form>
      </UI.Modal>}
      <ConfirmModal isOpen={confirmModal.open} message="ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?" onConfirm={()=>{setStaff(staff.filter(x=>x.id!==confirmModal.id)); setConfirmModal({open: false})}} onCancel={() => setConfirmModal({ open: false })} />
    </div>
  );
}

// =================================================================================
// [8] ì‹œê°„í‘œ ë° ìˆ˜ì—… ê´€ë¦¬ (í•™ë…„/ìš”ì¼ë³„ ì‹œìˆ˜ ì„¤ì • + UI ê°œì„ )
// =================================================================================

function ScheduleManager({ students, staff }) {
  const [semester, setSemester] = useState(1);
  const [schedule, setSchedule] = usePersistentState('integrated_schedule', {});
  
  // [ìˆ˜ì •] í•™ë…„ë³„/ìš”ì¼ë³„ ìƒì„¸ ì‹œê°„í‘œ ë°ì´í„° (ê¸°ë³¸ê°’: ëª¨ë‘ ìˆ˜ì—…í•¨(true))
  // êµ¬ì¡°: { 1: [[ì›”1~6], [í™”1~6], ...], 2: ... }
  const [gradeTimes, setGradeTimes] = usePersistentState('grade_timetables_detail', (() => {
    const init = {};
    [1,2,3,4,5,6].forEach(g => {
      init[g] = Array(5).fill(null).map(() => Array(6).fill(true));
    });
    return init;
  })());

  const [logicMode, setLogicMode] = useState('severity'); // 'severity' or 'equal'
  const [modal, setModal] = useState(null); 
  const [confirmModal, setConfirmModal] = useState({ open: false, type: null }); 
  const [gradeModal, setGradeModal] = useState(false);
  const [activeGradeTab, setActiveGradeTab] = useState(1); // ì‹œìˆ˜ ì„¤ì • ëª¨ë‹¬ì˜ í˜„ì¬ í•™ë…„ íƒ­
   
  const days = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ']; 
  const periods = [1,2,3,4,5,6];

  // ìë™ ë°°ì¹˜ ë¡œì§
  const autoAssign = () => {
    if(!staff.length) return alert('ë“±ë¡ëœ ì¸ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.');
    
    // ì´ˆê¸°í™”: ìˆ˜ë™ ì…ë ¥ëœ 'íŠ¹ìˆ˜í•™ê¸‰' ìˆ˜ì—…(type='special')ê³¼ 'ì°¨ë‹¨(blocked)'ì€ ìœ ì§€
    const newSch = { ...schedule, [semester]: { ...schedule[semester] } };
    Object.keys(newSch[semester]).forEach(k => {
        newSch[semester][k] = (newSch[semester][k] || []).filter(i => i.type === 'special' || i.blocked);
    });

    const studentCounts = {}; students.forEach(s => studentCounts[s.id] = 0);
    const staffCounts = {}; staff.forEach(s => staffCounts[s.id] = 0);

    // [ë¡œì§ 1: ì¤‘ì¦ë„ ìš°ì„ ]
    const assignSeverityFirst = (dayIdx, period, k) => {
        const slots = newSch[semester][k] || [];
        const busyStudentIds = slots.filter(i => i.type === 'special').map(i => i.studentId);
        
        // 1. í•˜êµ ì‹œê°„ í•„í„°ë§ (í•´ë‹¹ í•™ë…„, í•´ë‹¹ ìš”ì¼, í•´ë‹¹ êµì‹œê°€ falseë©´ ì œì™¸)
        let candidates = students.filter(s => {
            const isClassTime = gradeTimes[s.grade]?.[dayIdx]?.[period-1];
            return isClassTime && !busyStudentIds.includes(s.id);
        });

        // 2. ì¤‘ì¦ë„ ìˆœ ì •ë ¬ (1ìˆœìœ„ > 2ìˆœìœ„ > 3ìˆœìœ„)
        candidates.sort((a, b) => Number(a.severity) - Number(b.severity));

        const busyStaffIds = new Set(slots.filter(i => i.type === 'special' && i.staffId).map(i => i.staffId));
        const assignments = [];

        candidates.forEach(student => {
            const dedicatedStaff = staff.find(st => st.assignedStudentIds?.includes(student.id));
            
            if (dedicatedStaff && !busyStaffIds.has(dedicatedStaff.id)) {
                // ì „ë‹´ ì¸ë ¥ ìš°ì„  ë°°ì •
                assignments.push({ studentId: student.id, staffId: dedicatedStaff.id, type: 'support' });
                busyStaffIds.add(dedicatedStaff.id);
            } else if (!dedicatedStaff) {
                // ì „ë‹´ ì—†ëŠ” í•™ìƒì€ ë‚¨ëŠ” ì¸ë ¥ ë°°ì •
                const freeStaff = staff.find(st => !busyStaffIds.has(st.id));
                if (freeStaff) {
                    assignments.push({ studentId: student.id, staffId: freeStaff.id, type: 'support' });
                    busyStaffIds.add(freeStaff.id);
                }
            }
        });
        return assignments;
    };

    // [ë¡œì§ 2: ê· ë“± ë°°ì •]
    const assignEqual = (dayIdx, period, k) => {
        const slots = newSch[semester][k] || [];
        const busyStudentIds = slots.filter(i => i.type === 'special').map(i => i.studentId);
        
        // í•˜êµ ì‹œê°„ í•„í„°ë§
        let candidates = students.filter(s => {
            const isClassTime = gradeTimes[s.grade]?.[dayIdx]?.[period-1];
            return isClassTime && !busyStudentIds.includes(s.id);
        });

        candidates.sort((a, b) => studentCounts[a.id] - studentCounts[b.id]);
        
        const busyStaffIds = new Set(slots.filter(i => i.type === 'special' && i.staffId).map(i => i.staffId));
        const assignments = [];
        const freeStaff = staff.filter(st => !busyStaffIds.has(st.id)).sort((a,b) => staffCounts[a.id] - staffCounts[b.id]);

        while(freeStaff.length > 0 && candidates.length > 0) {
            const st = freeStaff.shift();
            const s = candidates.shift();
            assignments.push({ studentId: s.id, staffId: st.id, type: 'support' });
            studentCounts[s.id]++;
            staffCounts[st.id]++;
        }
        return assignments;
    };

    // ì „ì²´ ìŠ¬ë¡¯ ìˆœíšŒ
    days.forEach((d, dayIdx) => periods.forEach(p => {
        const k = `${d}-${p}`;
        if ((newSch[semester][k]||[]).some(i => i.blocked)) return;
        
        const newAssigns = logicMode === 'severity' ? assignSeverityFirst(dayIdx, p, k) : assignEqual(dayIdx, p, k);
        
        if(!newSch[semester][k]) newSch[semester][k] = [];
        newSch[semester][k].push(...newAssigns);
    }));

    setSchedule(newSch);
    setConfirmModal({ open: false });
  };

  const updateItem = (sid, key, val) => {
    let type = 'support';
    if (key === 'subject') type = 'special'; 

    let newData = modal.data.filter(i => i.studentId !== sid);
    if (val) newData.push({ studentId: sid, [key]: val, type: type, [key==='subject'?'supportId':'subject']: null });
    setModal({ ...modal, data: newData });
  };

  const toggleBlock = () => {
      const isBlocked = modal.data.some(i => i.blocked);
      setModal({ ...modal, data: isBlocked ? modal.data.filter(i => !i.blocked) : [...modal.data, { blocked: true }] });
  };

  // ì‹œìˆ˜ ì„¤ì • í† ê¸€ í•¨ìˆ˜
  const toggleGradeTime = (dayIdx, periodIdx) => {
    const newTimes = { ...gradeTimes };
    // í•´ë‹¹ í•™ë…„, í•´ë‹¹ ìš”ì¼, í•´ë‹¹ êµì‹œ í† ê¸€
    const dayTimes = [...newTimes[activeGradeTab][dayIdx]];
    dayTimes[periodIdx] = !dayTimes[periodIdx];
    newTimes[activeGradeTab][dayIdx] = dayTimes;
    setGradeTimes(newTimes);
  };

  return (
    <div className="p-8 h-full flex flex-col">
      <header className="flex flex-col gap-6 mb-6 shrink-0">
        <div className="flex justify-between items-center">
          <div><h2 className="text-3xl font-extrabold text-gray-800">í†µí•© ì‹œê°„í‘œ</h2></div>
          <div className="flex gap-2">
             <button onClick={() => setGradeModal(true)} className="px-4 py-2 bg-white border rounded-xl font-bold hover:bg-gray-50 flex items-center gap-2"><Clock size={18}/> í•™ë…„ë³„ ì‹œìˆ˜ ì„¤ì •</button>
             <div className="bg-gray-100 p-1 rounded-xl flex">
                 <button onClick={()=>setLogicMode('severity')} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${logicMode==='severity'?'bg-white shadow text-pink-600':'text-gray-400'}`}>ì¤‘ì¦ë„ ìš°ì„ </button>
                 <button onClick={()=>setLogicMode('equal')} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${logicMode==='equal'?'bg-white shadow text-blue-600':'text-gray-400'}`}>ê· ë“± ë°°ì •</button>
             </div>
             <button onClick={() => setConfirmModal({ open: true, type: 'auto' })} className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-xl font-bold shadow-md hover:scale-105 transition-transform"><Wand2 size={18}/> ìë™ ë°°ì¹˜</button>
             <button onClick={() => setConfirmModal({ open: true, type: 'reset' })} className="bg-gray-100 p-2 rounded-xl text-gray-500 hover:text-red-500"><RotateCcw size={20}/></button>
          </div>
        </div>
      </header>
      
      <div className="flex-1 bg-white p-4 rounded-[2rem] shadow-xl overflow-hidden flex flex-col">
        <div className="grid grid-cols-6 gap-2 mb-2 text-center h-12 shrink-0"><div className="font-bold text-gray-400 bg-gray-50 rounded-xl flex items-center justify-center">êµì‹œ</div>{days.map(d=><div key={d} className="font-extrabold text-lg text-gray-700 bg-gray-100 rounded-xl flex items-center justify-center">{d}</div>)}</div>
        <div className="flex-1 grid grid-rows-6 gap-2">{periods.map(p => <div key={p} className="grid grid-cols-6 gap-2"><div className="font-bold text-xl text-gray-400 bg-gray-50 rounded-xl flex items-center justify-center">{p}</div>{days.map(d => {
          const items = schedule[semester]?.[`${d}-${p}`] || [];
          const isBlocked = items.some(i => i.blocked);
          return (
            <div key={d} onClick={()=>setModal({ day: d, period: p, data: JSON.parse(JSON.stringify(items)) })} className={`bg-white border-2 rounded-xl hover:border-pink-300 hover:shadow-lg cursor-pointer p-1 overflow-hidden relative group transition-all ${isBlocked ? 'border-gray-200 bg-gray-50' : 'border-gray-100'}`}>
                {isBlocked ? <div className="w-full h-full flex items-center justify-center"><X className="text-gray-300" size={32} /></div> : (
                    <div className="flex flex-wrap gap-1 justify-center content-start h-full">
                        {items.map((i,x)=>{
                            const s = students.find(s=>s.id===i.studentId); const st = staff.find(s=>s.id===i.staffId); 
                            if(!s) return null;
                            const isSpecial = i.type === 'special';
                            // [ìˆ˜ì •] íŠ¹ìˆ˜í•™ê¸‰ í‘œì‹œëŠ” border-4ë¡œ ë” ì§„í•˜ê²Œ ê°•ì¡°
                            return <div key={x} className={`flex flex-col items-center text-[9px] px-1.5 py-0.5 rounded-md shadow-sm whitespace-nowrap ${getStudentColor(s.id)} ${isSpecial ? 'border-4 border-gray-700 font-extrabold ring-1 ring-white' : 'opacity-90 font-bold'}`}><span>{s.name}</span><span className="opacity-80 scale-90">{isSpecial ? (i.subject || 'íŠ¹ìˆ˜') : (st ? st.name : '?')}</span></div>
                        })}
                    </div>
                )}
            </div>
          );
        })}</div>)}</div>
      </div>
      
      {modal && <UI.Modal onClose={()=>setModal(null)} maxWidth="max-w-5xl" title={`${modal.day}ìš”ì¼ ${modal.period}êµì‹œ ì„¤ì •`}>
        <div className="flex justify-between items-center px-6 py-2 bg-gray-50 border-b"><span className="text-sm text-gray-500 font-bold">ê°œë³„ ì„¤ì •</span><button onClick={toggleBlock} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg font-bold text-sm ${modal.data.some(i=>i.blocked) ? 'bg-red-500 text-white' : 'bg-white border'}`}>{modal.data.some(i=>i.blocked) ? 'ê¸ˆì§€ í•´ì œ' : 'ë°°ì • ê¸ˆì§€'}</button></div>
        <div className={`flex-1 overflow-y-auto custom-scrollbar p-6 grid grid-cols-1 md:grid-cols-2 gap-4 ${modal.data.some(i=>i.blocked) ? 'opacity-50 pointer-events-none' : ''}`}>
          {students.map(s => {
            const entry = modal.data.find(i=>i.studentId===s.id);
            return (
              <div key={s.id} className={`p-4 rounded-2xl border-2 transition-all ${entry ? (entry.type==='special' ? 'border-gray-600 bg-gray-50 ring-2 ring-pink-100' : 'border-blue-400 bg-blue-50') : 'border-gray-100 bg-white'}`}>
                <div className="flex items-center justify-between mb-3"><div className="flex items-center gap-3"><img src={s.photo} className="w-10 h-10 rounded-full border bg-white"/><span className="font-bold">{s.name} <span className="text-xs font-normal text-gray-500">{s.grade}í•™ë…„ / {s.severity}ìˆœìœ„</span></span></div></div>
                <div className="space-y-2">
                  <div><span className="text-[10px] font-bold text-gray-400">íŠ¹ìˆ˜í•™ê¸‰ ìˆ˜ì—… (ì§ì ‘ì…ë ¥)</span> <div className="flex flex-wrap gap-1">{s.targetSubjects?.map(subj=><button key={subj} onClick={()=>updateItem(s.id, 'subject', entry?.subject===subj?null:subj)} className={`px-2 py-1 rounded text-xs font-bold border ${entry?.subject===subj?'bg-gray-800 text-white':'bg-white text-gray-600'}`}>{subj}</button>)}</div></div>
                  <div><span className="text-[10px] font-bold text-gray-400">ì›ë°˜ ì§€ì› ì¸ë ¥</span> <div className="flex flex-wrap gap-1">{staff.map(st=><button key={st.id} onClick={()=>updateItem(s.id, 'staffId', entry?.staffId===st.id?null:st.id)} className={`px-2 py-1 rounded text-xs font-bold border ${entry?.staffId===st.id?'bg-blue-600 text-white':'bg-white text-blue-600'}`}>{st.name}</button>)}</div></div>
                </div>
              </div>
            )
          })}
        </div>
        <div className="p-4 border-t flex justify-end gap-2"><UI.Btn variant="secondary" onClick={()=>setModal(null)}>ì·¨ì†Œ</UI.Btn><UI.Btn className="bg-gray-800" onClick={()=>{setSchedule({...schedule, [semester]: {...schedule[semester], [`${modal.day}-${modal.period}`]: modal.data}}); setModal(null)}}>ì €ì¥</UI.Btn></div>
      </UI.Modal>}
      
      {/* [ìˆ˜ì •] í•™ë…„ë³„ ì‹œìˆ˜ ì„¤ì • ëª¨ë‹¬ (í•™ë…„ íƒ­ + ìš”ì¼ë³„ ìƒì„¸ ê²©ì) */}
      {gradeModal && <UI.Modal onClose={()=>setGradeModal(false)} title="í•™ë…„ë³„ ìˆ˜ì—…/í•˜êµ ì„¤ì •" maxWidth="max-w-2xl">
          <div className="p-6">
              {/* í•™ë…„ íƒ­ */}
              <div className="flex gap-2 mb-6 border-b">
                  {[1,2,3,4,5,6].map(g => (
                      <button key={g} onClick={() => setActiveGradeTab(g)} className={`px-6 py-3 font-bold rounded-t-xl transition-all ${activeGradeTab === g ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-400 hover:bg-gray-200'}`}>{g}í•™ë…„</button>
                  ))}
              </div>
              
              {/* ì‹œê°„í‘œ ê²©ì (ìš”ì¼ x êµì‹œ) */}
              <div className="bg-gray-50 rounded-2xl p-4">
                  <div className="grid grid-cols-6 gap-2 mb-2 text-center text-sm font-bold text-gray-500">
                      <div>êµì‹œ</div>{days.map(d => <div key={d}>{d}ìš”ì¼</div>)}
                  </div>
                  {[0,1,2,3,4,5].map((periodIdx) => ( // 1~6êµì‹œ
                      <div key={periodIdx} className="grid grid-cols-6 gap-2 mb-2 items-center">
                          <div className="font-bold text-center text-gray-400">{periodIdx + 1}êµì‹œ</div>
                          {[0,1,2,3,4].map((dayIdx) => { // ì›”~ê¸ˆ
                              const isActive = gradeTimes[activeGradeTab]?.[dayIdx]?.[periodIdx];
                              return (
                                  <div 
                                    key={dayIdx} 
                                    onClick={() => toggleGradeTime(dayIdx, periodIdx)} 
                                    className={`h-10 rounded-lg cursor-pointer flex items-center justify-center border transition-all text-xs font-bold ${isActive ? 'bg-green-500 border-green-600 text-white shadow-sm' : 'bg-white border-gray-200 text-gray-300'}`}
                                  >
                                      {isActive ? 'ìˆ˜ì—…' : 'í•˜êµ'}
                                  </div>
                              );
                          })}
                      </div>
                  ))}
              </div>
              <div className="mt-6 flex justify-end"><UI.Btn className="bg-gray-800 px-8" onClick={()=>setGradeModal(false)}>ì„¤ì • ì™„ë£Œ</UI.Btn></div>
          </div>
      </UI.Modal>}

      <ConfirmModal isOpen={confirmModal.open} message={confirmModal.type === 'reset' ? "ì‹œê°„í‘œë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?" : `[${logicMode==='severity'?'ì¤‘ì¦ë„ ìš°ì„ ':'ê· ë“± ë°°ì •'}] ë¡œì§ìœ¼ë¡œ ìë™ ë°°ì¹˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ê¸°ì¡´ ì§€ì› ë‚´ì—­ì€ ì¬ì‘ì„±ë©ë‹ˆë‹¤)`} onConfirm={confirmModal.type === 'reset' ? () => {setSchedule({...schedule, [semester]:{}}); setConfirmModal({open:false});} : autoAssign} onCancel={() => setConfirmModal({ open: false, type: null })} />
    </div>
  );
}
// =================================================================================
// [9] ì˜ˆì‚° ê´€ë¦¬ (BudgetManager & í•˜ìœ„ í¼) - ê¸°ì¡´ ì™„ì„±ë³¸ ìœ ì§€
// =================================================================================

function BudgetManager() {
  // â˜…â˜…â˜… êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ì›¹ì•± URLì„ ê¼­ ë„£ì–´ì£¼ì„¸ìš”! â˜…â˜…â˜…
  const GAS_URL = "https://script.google.com/macros/s/AKfycbwPGP3XD0UiXgBirn2vu9N0lzD_-0wOrJJuVaiA5MhSoHylwoYrEzH8G_Xu_5nHTjpo/exec"; 
  
  const [items, setItems] = useState([]); 
  const [budgets, setBudgets] = usePersistentState('budget_definitions', [{ id: 'default', name: 'í•™ê¸‰ìš´ì˜ë¹„', total: 300000 }]); 
  const [activeTab, setActiveTab] = useState(budgets[0]?.name || '');
  const [loading, setLoading] = useState(false);
  const [modal, setModal] = useState(null); 
  const [confirm, setConfirm] = useState(null); 

  useEffect(() => { if (budgets.length > 0 && !budgets.find(b => b.name === activeTab)) setActiveTab(budgets[0].name); }, [budgets, activeTab]);

  const stats = useMemo(() => {
    const currentBudget = budgets.find(b => b.name === activeTab);
    const totalLimit = currentBudget ? Number(currentBudget.total) : 0;
    const currentItems = items.filter(i => i.category === activeTab);
    const totalExpense = currentItems.reduce((acc, cur) => acc + Number(cur.amount), 0);
    return { total: totalLimit, used: totalExpense, remain: totalLimit - totalExpense };
  }, [items, budgets, activeTab]);

  const fetchData = async () => {
    if(!GAS_URL || GAS_URL.includes("ì—¬ê¸°ì—")) return;
    setLoading(true);
    try { const res = await fetch(GAS_URL); const data = await res.json(); setItems(Array.isArray(data) ? data : []); } catch (err) { console.error("Load Error"); } finally { setLoading(false); }
  };

  const saveItem = async (formData) => {
    setLoading(true);
    const newItem = formData.id ? formData : { ...formData, id: Date.now() };
    if (formData.id) setItems(items.map(i => i.id === formData.id ? newItem : i)); else setItems([newItem, ...items]);
    setModal(null);
    try { await fetch(GAS_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" }, body: JSON.stringify(newItem) }); } catch (err) { alert("ì €ì¥ ì˜¤ë¥˜"); } finally { setLoading(false); }
  };

  const executeDelete = async () => {
    if (!confirm) return;
    if (confirm.type === 'item') {
      const targetId = confirm.data.id; setLoading(true); setItems(items.filter(i => i.id !== targetId)); setConfirm(null);
      try { await fetch(GAS_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ action: 'delete', id: targetId }) }); } catch (err) { alert("ì‚­ì œ ì˜¤ë¥˜"); } finally { setLoading(false); }
    } else if (confirm.type === 'budget') {
      const newBudgets = budgets.filter(b => b.name !== activeTab); setBudgets(newBudgets); setActiveTab(newBudgets[0].name); setConfirm(null);
    }
  };

  const saveBudget = (newBudget) => { if (budgets.some(b => b.name === newBudget.name)) return alert("ì¤‘ë³µëœ ì´ë¦„"); setBudgets([...budgets, { ...newBudget, id: Date.now() }]); setActiveTab(newBudget.name); setModal(null); };

  useEffect(() => { fetchData(); }, []);
  const fmt = (n) => new Intl.NumberFormat('ko-KR').format(n);
  const filteredItems = items.filter(i => i.category === activeTab);

  return (
    <div className="p-8 h-full flex flex-col">
      <div className="flex justify-between items-center mb-6">
        <h2 className="text-3xl font-extrabold text-gray-800">í•™ê¸‰ ì˜ˆì‚° ê´€ë¦¬</h2>
        <div className="flex gap-2">
          <button onClick={() => setModal('add_budget')} className="flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-600 rounded-xl font-bold hover:bg-blue-100 transition-colors"><Plus size={18}/> ì˜ˆì‚° í•­ëª© ì¶”ê°€</button>
          <button onClick={fetchData} className={`p-2.5 rounded-full bg-white border shadow hover:bg-gray-50 ${loading ? 'animate-spin' : ''}`}><RefreshCcw size={20} className="text-gray-600"/></button>
        </div>
      </div>
      <div className="flex justify-between items-end border-b mb-6">
        <div className="flex gap-2 overflow-x-auto custom-scrollbar pb-2 max-w-[80%]">{budgets.map(b => (<button key={b.id} onClick={() => setActiveTab(b.name)} className={`px-5 py-2 rounded-t-2xl text-sm font-bold whitespace-nowrap transition-all border-b-0 ${activeTab === b.name ? 'bg-gray-800 text-white shadow-lg translate-y-[1px]' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>{b.name}</button>))}</div>
        <button onClick={()=>{if(budgets.length<=1)return alert('ìµœì†Œ 1ê°œ ìœ ì§€'); setConfirm({type:'budget', data:activeTab})}} className="mb-2 text-xs text-red-400 hover:text-red-600 font-bold flex items-center gap-1 px-3 py-1 bg-red-50 rounded-lg"><Trash2 size={12}/> í˜„ì¬ ì˜ˆì‚° ì‚­ì œ</button>
      </div>
      {activeTab && (
        <div className="bg-white rounded-3xl p-6 shadow-xl border border-gray-100 mb-6 flex flex-col md:flex-row justify-between items-center gap-6">
            <div className="flex items-center gap-4 w-full md:w-auto"><div className="w-16 h-16 rounded-2xl flex items-center justify-center text-3xl bg-pink-100 text-pink-600">ğŸ“‚</div><div><div className="text-sm text-gray-400 font-bold mb-1">{activeTab} ì”ì•¡</div><div className={`text-3xl font-extrabold ${stats.remain < 0 ? 'text-red-500' : 'text-gray-800'}`}>{fmt(stats.remain)}ì›</div></div></div>
            <div className="flex gap-8 w-full md:w-auto bg-gray-50 p-4 rounded-2xl justify-around"><div><div className="text-xs text-gray-400 font-bold">ë°°ì • ì˜ˆì‚°</div><div className="text-lg font-bold text-blue-600">{fmt(stats.total)}</div></div><div className="w-px bg-gray-200"></div><div><div className="text-xs text-gray-400 font-bold">í˜„ì¬ ì‚¬ìš©ì•¡</div><div className="text-lg font-bold text-red-500">{fmt(stats.used)}</div></div></div>
        </div>
      )}
      <div className="flex-1 bg-white rounded-[2rem] shadow border overflow-hidden flex flex-col">
        <div className="p-4 bg-gray-50 border-b flex font-bold text-gray-500 text-xs text-center"><div className="w-24">ë‚ ì§œ</div><div className="w-24">ì‚¬ìš©ì²˜</div><div className="flex-1 text-left pl-4">ë‚´ì—­</div><div className="w-24 text-right pr-4">ê¸ˆì•¡</div><div className="w-16">ê´€ë¦¬</div></div>
        <div className="flex-1 overflow-y-auto custom-scrollbar">
          {filteredItems.length > 0 ? filteredItems.map(item => (
            <div key={item.id} className="flex items-center p-4 border-b hover:bg-gray-50 transition-colors text-sm"><div className="w-24 text-center text-gray-500 text-xs">{item.date}</div><div className="w-24 text-center"><span className="px-2 py-1 bg-blue-50 text-blue-600 rounded-md text-xs font-bold truncate block">{item.vendor}</span></div><div className="flex-1 text-left pl-4 font-bold text-gray-700">{item.item}{item.memo && <span className="text-xs text-gray-400 font-normal ml-2">- {item.memo}</span>}</div><div className="w-24 text-right pr-4 font-bold text-red-500">-{fmt(item.amount)}</div><div className="w-16 flex justify-center gap-2"><button onClick={() => setModal({ type: 'item', data: item })} className="text-gray-400 hover:text-blue-500"><Edit2 size={16}/></button><button onClick={() => setConfirm({type:'item', data:item})} className="text-gray-400 hover:text-red-500"><Trash2 size={16}/></button></div></div>
          )) : <div className="h-full flex flex-col items-center justify-center text-gray-400 opacity-50"><Coins size={48} className="mb-4"/><p>ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>}
        </div>
      </div>
      {activeTab && <button onClick={() => setModal({ type: 'item', data: null })} className="fixed bottom-8 right-8 w-16 h-16 bg-gray-800 text-white rounded-full shadow-2xl flex items-center justify-center hover:scale-110 transition-transform z-20"><Edit2 size={28}/></button>}
      {modal === 'add_budget' && <UI.Modal onClose={() => setModal(null)} title="ìƒˆ ì˜ˆì‚° í•­ëª© ì¶”ê°€" maxWidth="max-w-sm"><BudgetDefForm onSave={saveBudget} onClose={() => setModal(null)} /></UI.Modal>}
      {modal?.type === 'item' && <UI.Modal onClose={() => setModal(null)} title={modal.data ? "ìˆ˜ì •" : "ê¸°ë¡"} maxWidth="max-w-sm"><BudgetForm activeTab={activeTab} initialData={modal.data} onSave={saveItem} onClose={() => setModal(null)} /></UI.Modal>}
      <ConfirmModal isOpen={!!confirm} message={confirm?.type === 'budget' ? `'${confirm?.data}' ì˜ˆì‚° í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?` : "ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì‹œíŠ¸ ë°˜ì˜)"} onConfirm={executeDelete} onCancel={() => setConfirm(null)} />
    </div>
  );
}

function BudgetDefForm({ onSave, onClose }) {
  const [name, setName] = useState(''); const [total, setTotal] = useState('');
  return <div className="p-6 space-y-4"><div className="bg-blue-50 p-4 rounded-xl text-xs text-blue-600 mb-2">ğŸ’¡ ì˜ˆì‚° í†µì¥ì„ ë§Œë“­ë‹ˆë‹¤.</div><UI.Input label="ì˜ˆì‚°ëª…" value={name} onChange={e=>setName(e.target.value)} /><UI.Input label="ì´ ê¸ˆì•¡" value={total} onChange={e=>setTotal(e.target.value.replace(/[^0-9]/g, ''))} placeholder="ìˆ«ìë§Œ" /><div className="flex gap-2 mt-4"><UI.Btn variant="secondary" className="flex-1" onClick={onClose}>ì·¨ì†Œ</UI.Btn><UI.Btn className="flex-1 bg-blue-500" onClick={() => { if(name&&total) onSave({name, total}); }}>ë§Œë“¤ê¸°</UI.Btn></div></div>;
}

function BudgetForm({ activeTab, initialData, onSave, onClose }) {
  const [form, setForm] = useState(initialData || { date: new Date().toISOString().slice(0,10), category: activeTab, vendor: '', item: '', amount: '', memo: '' });
  return <form onSubmit={e=>{e.preventDefault(); if(!form.vendor||!form.amount)return alert('í•„ìˆ˜ì…ë ¥'); onSave(form);}} className="flex flex-col h-full max-h-[80vh]"><div className="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-4"><div className="bg-gray-50 border p-3 rounded-xl text-sm font-bold text-center text-gray-600">{form.category}</div><UI.Input label="ë‚ ì§œ" type="date" value={form.date} onChange={e=>setForm({...form, date:e.target.value})} /><UI.Input label="ì‚¬ìš©ì²˜" value={form.vendor} onChange={e=>setForm({...form, vendor:e.target.value})} /><UI.Input label="í’ˆëª©" value={form.item} onChange={e=>setForm({...form, item:e.target.value})} /><UI.Input label="ê¸ˆì•¡" value={form.amount} onChange={e=>setForm({...form, amount:e.target.value.replace(/[^0-9]/g, '')})} /><UI.Input label="ë©”ëª¨" value={form.memo} onChange={e=>setForm({...form, memo:e.target.value})} /></div><div className="p-4 border-t bg-white flex gap-2"><UI.Btn type="button" variant="secondary" className="flex-1" onClick={onClose}>ì·¨ì†Œ</UI.Btn><UI.Btn className="flex-1 bg-gray-800" type="submit">ì €ì¥</UI.Btn></div></form>;
}

// =================================================================================
// [10] ê¸°íƒ€ ì»´í¬ë„ŒíŠ¸ (ê°œë³„í™”/ì‚¬ì§„/ì„¤ì •/íˆ¬ë‘) - ê¸°ì¡´ ìœ ì§€
// =================================================================================

function EducationManager({ students }) {
  const [s, setS] = useState(null);
  return <div className="p-8 max-w-7xl mx-auto"><h2 className="text-3xl font-extrabold mb-8">ê°œë³„í™” êµìœ¡ ê³„íš</h2><div className="grid grid-cols-1 sm:grid-cols-3 gap-6">{students.map(st=><div key={st.id} onClick={()=>setS(st)} className={`cursor-pointer bg-white p-6 rounded-3xl shadow border-4 ${getStudentColor(st.id)} hover:-translate-y-2 transition-all`}><div className="font-bold text-xl text-center">{st.name}</div></div>)}</div>{s&&<UI.Modal onClose={()=>setS(null)} title={`${s.name} IEP`}><div className="p-10 text-center text-gray-400"><Book size={40} className="mx-auto mb-4 opacity-50"/><p>ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤</p></div></UI.Modal>}</div>;
}

function PhotoManager() {
  const [ps, setPs] = usePersistentState('class_photos', []); const [m, setM] = useState(null);
  const add = (d) => { setPs([{...d, id:Date.now(), comments:[], date:new Date().toLocaleDateString()}, ...ps]); setM(null); };
  return <div className="p-8 h-full flex flex-col"><h2 className="text-3xl font-extrabold mb-8">ì•¨ë²” ({ps.length})</h2><div className="grid grid-cols-3 gap-4">{ps.map(p=><div key={p.id} onClick={()=>setM(p)} className="aspect-square bg-white border rounded-xl overflow-hidden cursor-pointer"><img src={p.url} className="w-full h-full object-contain"/></div>)}</div><button onClick={()=>setM('up')} className="fixed bottom-8 right-8 w-16 h-16 bg-pink-500 text-white rounded-full shadow-2xl flex items-center justify-center"><Plus size={32}/></button>{m==='up'&&<UI.Modal onClose={()=>setM(null)} title="ì—…ë¡œë“œ"><PhotoUp onSave={add}/></UI.Modal>}{m&&m!=='up'&&<UI.Modal onClose={()=>setM(null)} maxWidth="max-w-4xl"><div className="flex h-[80vh]"><img src={m.url} className="w-3/5 object-contain bg-black"/><div className="w-2/5 bg-white p-4 border-l"><div className="font-bold border-b pb-2">{m.caption}</div><div className="mt-4 text-gray-400 text-sm">ëŒ“ê¸€ ê¸°ëŠ¥ ì¤€ë¹„ì¤‘</div><button onClick={()=>{setPs(ps.filter(x=>x.id!==m.id)); setM(null)}} className="mt-4 text-red-500 text-sm">ì‚­ì œ</button></div></div></UI.Modal>}</div>;
}

const PhotoUp = ({ onSave }) => {
  const [i, setI] = useState(null); const [c, setC] = useState(''); const r = useRef();
  return <div className="p-4"><div onClick={()=>r.current.click()} className="aspect-square bg-gray-50 rounded-xl flex items-center justify-center cursor-pointer mb-4 border-2 border-dashed">{i?<img src={i} className="max-h-full"/>:'ì‚¬ì§„ ì„ íƒ'}<input type="file" ref={r} onChange={e=>{const f=e.target.files[0]; if(f){const rd=new FileReader(); rd.onloadend=()=>setI(rd.result); rd.readAsDataURL(f)}}} className="hidden"/></div><textarea value={c} onChange={e=>setC(e.target.value)} className="w-full p-2 border rounded-xl" placeholder="ì„¤ëª…"/><UI.Btn className="w-full mt-4" onClick={()=>i&&onSave({url:i, caption:c})}>ë“±ë¡</UI.Btn></div>;
};

function SettingsPage({ storedPw, setStoredPw, security, setSecurity, showGlobalError }) {
  const r = useRef();
  const backup = () => { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(STORAGE_KEYS.reduce((a,k)=>({...a,[k]:localStorage.getItem(k)}),{}))], {type:'json'})); a.download=`backup.json`; a.click(); };
  const restore = (e) => { const rd = new FileReader(); rd.onload = (ev) => { try { const d=JSON.parse(ev.target.result); STORAGE_KEYS.forEach(k=>{if(d[k])localStorage.setItem(k,d[k])}); alert('ë³µêµ¬ë¨'); window.location.reload(); } catch { showGlobalError('íŒŒì¼ ì˜¤ë¥˜'); } }; if(e.target.files[0]) rd.readAsText(e.target.files[0]); };
  return <div className="p-8 max-w-2xl mx-auto"><h2 className="text-3xl font-extrabold mb-8">ì„¤ì •</h2><div className="space-y-4"><div className="bg-white p-6 rounded-3xl shadow border"><h3 className="font-bold mb-4">ë°ì´í„° ê´€ë¦¬</h3><div className="flex gap-4"><button onClick={backup} className="flex-1 p-4 bg-blue-50 text-blue-600 rounded-xl font-bold flex items-center justify-center gap-2"><Download/> ë°±ì—…</button><button onClick={()=>r.current.click()} className="flex-1 p-4 bg-green-50 text-green-600 rounded-xl font-bold flex items-center justify-center gap-2"><Upload/> ë³µêµ¬</button><input type="file" ref={r} onChange={restore} className="hidden" accept=".json"/></div><button onClick={()=>{if(confirm('ì „ì²´ ì´ˆê¸°í™”?')) {localStorage.clear(); window.location.reload();}}} className="w-full mt-4 text-red-400 text-sm">âš ï¸ ì´ˆê¸°í™”</button></div></div></div>;
}

function TodoListModal({ onClose }) {
  const [todos, setTodos] = usePersistentState('teacher_todos', []); const [t, setT] = useState('');
  return <UI.Modal onClose={onClose} title="í•  ì¼"><div className="p-4 h-[50vh] flex flex-col"><div className="flex gap-2 mb-4"><input value={t} onChange={e=>setT(e.target.value)} className="flex-1 p-2 border rounded-lg"/><UI.Btn onClick={()=>{if(t){setTodos([...todos,{id:Date.now(),text:t,done:false}]);setT('')}}} className="px-4 py-2">ì¶”ê°€</UI.Btn></div><div className="flex-1 overflow-y-auto space-y-2">{todos.map(i=><div key={i.id} className="flex gap-2 items-center p-2 border rounded"><input type="checkbox" checked={i.done} onChange={()=>setTodos(todos.map(x=>x.id===i.id?{...x,done:!x.done}:x))}/><span className={i.done?'line-through text-gray-400':''}>{i.text}</span><button onClick={()=>setTodos(todos.filter(x=>x.id!==i.id))} className="ml-auto text-red-400"><X size={14}/></button></div>)}</div></div></UI.Modal>;
}

function RecoveryModal({ securityData, onClose, onSuccess, onError }) {
  const [s, setS] = useState(1); const [a, setA] = useState(''); const [p, setP] = useState('');
  return <UI.Modal onClose={onClose}><div className="p-6 text-center">{s===1 ? <><div className="font-bold mb-4">Q. {securityData?.question}</div><UI.Input value={a} onChange={e=>setA(e.target.value)} placeholder="ì •ë‹µ"/><div className="flex gap-2 mt-4"><UI.Btn variant="secondary" onClick={onClose} className="flex-1">ì·¨ì†Œ</UI.Btn><UI.Btn onClick={()=>a===securityData?.answer?setS(2):onError('ì˜¤ë‹µ')} className="flex-1">í™•ì¸</UI.Btn></div></> : <><UI.Input type="password" value={p} onChange={e=>setP(e.target.value)} placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸"/><UI.Btn onClick={()=>onSuccess(p)} className="w-full mt-4">ë³€ê²½</UI.Btn></>}</div></UI.Modal>;
}