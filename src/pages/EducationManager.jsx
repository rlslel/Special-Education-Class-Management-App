import React, { useState, useEffect } from 'react';
import { RefreshCcw, Plus, Trash2, Wand2 } from 'lucide-react';
import { usePersistentState, callGAS, callGemini, getStudentColor } from '../utils/helpers';
import { UI, ConfirmModal } from '../components/SharedUI';

export default function EducationManager({ students }) {
  const [gasUrl] = usePersistentState('gas_app_url', '');
  const [selectedStudent, setSelectedStudent] = useState(null);
  const [iepData, setIepData] = useState({}); const [meetingList, setMeetingList] = useState([]); const [loading, setLoading] = useState(false); const [confirm, setConfirm] = useState(null);
  
  const fetchData = async () => { setLoading(true); const data = await callGAS(gasUrl); if(data) { const f = {}; (data.iep||[]).forEach(r => f[`${r.studentId}_${r.month}`] = r); setIepData(f); setMeetingList(data.meetings || []); } setLoading(false); };
  useEffect(() => { fetchData(); }, [gasUrl]);
  
  const saveDaily = async (studentId, month, record) => { setLoading(true); setIepData(p => ({ ...p, [`${studentId}_${month}`]: record })); await callGAS(gasUrl, { type: 'iep', studentId, month, ...record }); setLoading(false); };
  const saveMeeting = async (mData) => { setLoading(true); const nM = mData.id ? mData : { ...mData, id: Date.now() }; setMeetingList(mData.id ? meetingList.map(m => m.id === mData.id ? nM : m) : [nM, ...meetingList]); await callGAS(gasUrl, { type: 'iep_meeting', ...nM }); setLoading(false); };
  const executeDelete = async () => { const id = confirm.id; setLoading(true); setMeetingList(meetingList.filter(m => m.id !== id)); setConfirm(null); await callGAS(gasUrl, { type: 'iep_meeting', action: 'delete', id }); setLoading(false); };

  return (
    <div className="p-8 max-w-7xl mx-auto"><div className="flex justify-between items-center mb-8"><h2 className="text-3xl font-extrabold text-gray-800">ê°œë³„í™” êµìœ¡ ê³„íš (IEP)</h2><button onClick={fetchData} className={`p-2.5 rounded-full bg-white border shadow hover:bg-gray-50 ${loading ? 'animate-spin' : ''}`}><RefreshCcw size={20} className="text-gray-600"/></button></div>
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">{students.map(s => (<div key={s.id} onClick={() => setSelectedStudent(s)} className={`cursor-pointer bg-white p-6 rounded-3xl shadow-lg border-4 ${getStudentColor(s.id)} hover:-translate-y-2 transition-all flex items-center gap-4`}><img src={s.photo} className="w-16 h-16 rounded-full border-2 border-white shadow-sm bg-gray-100 object-cover"/><div><div className="font-bold text-xl text-gray-800">{s.name}</div><div className="text-xs text-gray-500 mt-1">{s.grade}í•™ë…„ {s.classNumber}ë°˜</div></div></div>))}</div>
      {selectedStudent && <UI.Modal onClose={() => setSelectedStudent(null)} title={`${selectedStudent.name} í•™ìƒ ê¸°ë¡ë¶€`} maxWidth="max-w-5xl"><IEPTabContainer student={selectedStudent} iepData={iepData} meetingList={meetingList.filter(m => String(m.studentId) === String(selectedStudent.id))} onSaveDaily={saveDaily} onSaveMeeting={saveMeeting} onDeleteMeeting={(id) => setConfirm({ type: 'delete_meeting', id })} loading={loading} /></UI.Modal>}
      <ConfirmModal isOpen={!!confirm} message="ì´ í˜‘ì˜ë¡ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì‹œíŠ¸ì—ì„œë„ ì‚­ì œë©ë‹ˆë‹¤)" onConfirm={executeDelete} onCancel={() => setConfirm(null)} />
    </div>
  );
}

function IEPTabContainer({ student, iepData, meetingList, onSaveDaily, onSaveMeeting, onDeleteMeeting, loading }) {
  const [tab, setTab] = useState('daily');
  return <div className="h-[80vh] flex flex-col bg-gray-50"><div className="flex border-b bg-white px-6"><button onClick={() => setTab('daily')} className={`py-4 px-6 font-bold border-b-2 transition-all ${tab === 'daily' ? 'border-pink-500 text-pink-600' : 'border-transparent text-gray-400'}`}>ì›”ë³„ êµìœ¡ ê¸°ë¡</button><button onClick={() => setTab('meeting')} className={`py-4 px-6 font-bold border-b-2 transition-all ${tab === 'meeting' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-400'}`}>ê°œë³„í™” í˜‘ì˜ë¡ ({meetingList.length})</button></div><div className="flex-1 overflow-hidden">{tab === 'daily' ? <IEPDailyForm student={student} data={iepData} onSave={onSaveDaily} loading={loading} /> : <IEPMeetingList student={student} list={meetingList} onSave={onSaveMeeting} onDelete={onDeleteMeeting} />}</div></div>;
}

function IEPDailyForm({ student, data, onSave, loading }) {
  const [semester, setSemester] = useState(1); const months = semester === 1 ? [3, 4, 5, 6, 7] : [8, 9, 10, 11, 12, 1]; const [activeMonth, setActiveMonth] = useState(months[0]); const [temp, setTemp] = useState({ goal: '', material: '', note: '' });
  useEffect(() => { setTemp(data[`${student.id}_${activeMonth}`] || { goal: '', material: '', note: '' }); }, [activeMonth, student, data]);
  
  return <div className="flex flex-col h-full"><div className="px-6 py-4 flex justify-between items-center bg-white border-b shrink-0"><div className="flex gap-2 overflow-x-auto custom-scrollbar">{months.map(m => (<button key={m} onClick={() => setActiveMonth(m)} className={`px-4 py-2 rounded-lg font-bold text-sm border transition-all ${activeMonth === m ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-400 border-gray-200'}`}>{m}ì›”</button>))}</div><div className="flex bg-gray-100 p-1 rounded-lg text-xs font-bold shrink-0 ml-4"><button onClick={()=>{setSemester(1);setActiveMonth(3)}} className={`px-3 py-1 rounded ${semester===1?'bg-white shadow text-pink-600':'text-gray-400'}`}>1í•™ê¸°</button><button onClick={()=>{setSemester(2);setActiveMonth(8)}} className={`px-3 py-1 rounded ${semester===2?'bg-white shadow text-blue-600':'text-gray-400'}`}>2í•™ê¸°</button></div></div><div className="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-6"><div className="flex items-center justify-between pb-4 border-b border-dashed"><div className="flex items-center gap-2"><span className="text-2xl">ğŸ“</span><h3 className="font-bold text-lg">{activeMonth}ì›” í™œë™ ê¸°ë¡</h3></div><UI.Btn onClick={() => onSave(student.id, activeMonth, temp)} disabled={loading} className="py-2 px-4 text-sm">{loading ? 'ì €ì¥ì¤‘' : 'ì €ì¥í•˜ê¸°'}</UI.Btn></div><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><UI.Input label="ğŸ¯ ì´ë‹¬ì˜ ëª©í‘œ" value={temp.goal} onChange={e=>setTemp({...temp, goal:e.target.value})} /><UI.Input label="ğŸ“š êµì¬ ë° êµêµ¬" value={temp.material} onChange={e=>setTemp({...temp, material:e.target.value})} /></div><div className="flex flex-col h-64"><label className="text-xs font-bold text-gray-400 mb-1 ml-1">ğŸ“ ì›”ê°„ ê´€ì°° ê¸°ë¡</label><textarea lang="ko" value={temp.note} onChange={e=>setTemp({...temp, note:e.target.value})} className="flex-1 w-full p-4 bg-yellow-50 border border-yellow-200 rounded-xl outline-none resize-none focus:ring-2 focus:ring-yellow-300" placeholder="ë‚´ìš© ì…ë ¥" /></div></div></div>;
}

function IEPMeetingList({ student, list, onSave, onDelete }) {
  const [view, setView] = useState('list'); const [editData, setEditData] = useState(null);
  const startEdit = (data) => { setEditData(data || { studentId: student.id, date: new Date().toISOString().slice(0,10), attendees: '', subjects: student.targetSubjects?.join(', ') || '', agreement: '', original: '', summary: '' }); setView('edit'); };
  
  return view === 'list' ? (<div className="flex flex-col h-full p-6"><div className="flex justify-between items-center mb-6"><h3 className="font-bold text-lg">í˜‘ì˜ë¡ ëª©ë¡</h3><button onClick={() => startEdit(null)} className="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-xl font-bold hover:bg-blue-600"><Plus size={18}/> ìƒˆ í˜‘ì˜ë¡ ì‘ì„±</button></div><div className="flex-1 overflow-y-auto custom-scrollbar space-y-3">{list.length > 0 ? list.map(m => (<div key={m.id} onClick={() => startEdit(m)} className="bg-white border rounded-xl p-4 hover:shadow-md cursor-pointer transition-all flex justify-between items-center"><div><div className="font-bold text-gray-800 mb-1">{m.date} í˜‘ì˜íšŒ</div><div className="text-xs text-gray-500 truncate max-w-md">{m.attendees} ì°¸ì„ / {m.subjects}</div></div><button onClick={(e) => {e.stopPropagation(); onDelete(m.id)}} className="p-2 text-gray-300 hover:text-red-500"><Trash2 size={16}/></button></div>)) : <div className="text-center text-gray-400 py-10">ì‘ì„±ëœ í˜‘ì˜ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>}</div></div>) : (<IEPMeetingForm student={student} initialData={editData} onSave={d => { onSave(d); setView('list'); }} onCancel={() => setView('list')} />);
}

function IEPMeetingForm({ student, initialData, onSave, onCancel }) {
  const [form, setForm] = useState(initialData); const [aiLoading, setAiLoading] = useState(false);
  
  const toggleRole = (r) => { const roles = (form.attendees||'').split(', ').filter(x=>x); setForm({...form, attendees: roles.includes(r)?roles.filter(x=>x!==r).join(', '):[...roles,r].join(', ')}) };
  const toggleBoilerplate = (text) => { if (form.agreement.includes(text)) { setForm(prev => ({ ...prev, agreement: prev.agreement.replace(text, '').replace(/\n\n/g, '\n').trim() })); } else { setForm(prev => ({ ...prev, agreement: (prev.agreement ? prev.agreement + "\n\n" : "") + text })); } };
  
  const handleAISummary = async () => {
    const key = localStorage.getItem('google_api_key'); if(!key) return alert("ì„¤ì • íƒ­ì—ì„œ Google API í‚¤ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.");
    if(!form.original) return alert("íšŒì˜ë¡ ì›ë³¸ ë‚´ìš©ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”."); setAiLoading(true);
    try { const txt = await callGemini(JSON.parse(key)||key, `ë‹¹ì‹ ì€ íŠ¹ìˆ˜êµìœ¡ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒ íšŒì˜ ë…¹ì·¨ë¡(Raw Data)ì„ ë¶„ì„í•˜ì—¬, 'ê³µì‹ì ì¸ ê°œë³„í™”êµìœ¡ì§€ì›íŒ€ í˜‘ì˜ë¡'ì— ë“¤ì–´ê°ˆ ì •ëˆë˜ê³  ì „ë¬¸ì ì¸ êµìœ¡ ìš©ì–´ë¡œ ìš”ì•½ ì •ë¦¬í•´ì£¼ì„¸ìš”. ë¬¸ì²´ëŠ” ê±´ì¡°í•˜ê³  ëª…í™•í•˜ê²Œ ì‘ì„±í•˜ì„¸ìš”.\n\n[ë…¹ì·¨ë¡]: ${form.original}`); if(txt) setForm(p=>({...p, summary:txt})); else alert("ìš”ì•½ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."); } catch(e){ alert("AI ìš”ì•½ ì‹¤íŒ¨: " + e.message); } finally { setAiLoading(false); }
  };
  
  const BOILERPLATES = [ { label: "ì‹ ì²´ì  ê°œì…", text: "ë³¸ì¸ ë° íƒ€ì¸ì˜ ì•ˆì „ì„ ìœ„í˜‘í•˜ëŠ” ëŒë°œí–‰ë™(ìí•´, íƒ€í•´ ë“±) ë°œìƒ ì‹œ, êµì‚¬ê°€ ì¦‰ê°ì ì¸ ì‹ ì²´ì  ê°œì…(ì†ëª© ê°€ì´ë“œ, íƒ€ì„ì•„ì›ƒ ë“±)ì„ í†µí•´ ì•ˆì „ì„ í™•ë³´í•˜ëŠ” ê²ƒì— ëŒ€í•´ ë³´í˜¸ìê°€ ì¶©ë¶„íˆ ì¸ì§€í•˜ê³  ë™ì˜í•¨." }, { label: "êµìœ¡ê³¼ì • ì¡°ì •", text: "í†µí•©í•™ê¸‰ ìˆ˜ì—… ì¤‘ í•™ìƒì˜ í˜„í–‰ ìˆ˜ì¤€ê³¼ íŠ¹ì„±ì„ ê³ ë ¤í•˜ì—¬, íŠ¹ìˆ˜êµì‚¬ê°€ ë³„ë„ì˜ í•™ìŠµì§€ ì œê³µ ë˜ëŠ” ìˆ˜ì •ëœ ê³¼ì œë¥¼ ì œì‹œí•˜ëŠ” ê²ƒì— ë™ì˜í•¨." }, { label: "í–‰ë™ ì¤‘ì¬", text: "ê¸ì •ì  í–‰ë™ ì§€ì›ì„ ìœ„í•´ ê°•í™”ë¬¼(ê°„ì‹, í† í° ë“±) ì‚¬ìš© ë° íƒ€ì„ì•„ì›ƒ ì ˆì°¨ë¥¼ ì ìš©í•˜ë©°, ê°€ì •ì—ì„œë„ ì¼ê´€ëœ ì§€ë„ë¥¼ ì—°ê³„í•˜ê¸°ë¡œ í•¨." }, { label: "ì‘ê¸‰ ì²˜ì¹˜", text: "ì‘ê¸‰ ìƒí™© ë°œìƒ ì‹œ í•™êµì˜ ì•ˆì „ ë§¤ë‰´ì–¼ì— ë”°ë¼ ì¡°ì¹˜í•˜ë©°, ë³´í˜¸ìì—ê²Œ ì¦‰ì‹œ ì—°ë½ ì·¨í•¨. ì—°ë½ì´ ë‹¿ì§€ ì•Šì„ ê²½ìš° ë³‘ì› ì´ì†¡ ë“±ì— ë™ì˜í•¨." } ];

  return (
    <div className="flex flex-col h-full bg-white"><div className="p-4 border-b flex items-center justify-between bg-gray-50"><h3 className="font-bold">ğŸ“ í˜‘ì˜ë¡ ì‘ì„±</h3><div className="flex gap-2"><button onClick={onCancel} className="px-4 py-2 bg-white border rounded-lg text-sm font-bold">ì·¨ì†Œ</button><button onClick={() => onSave(form)} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold">ì €ì¥í•˜ê¸°</button></div></div>
      <div className="flex-1 overflow-y-auto custom-scrollbar p-6"><div className="grid grid-cols-2 gap-6 mb-6"><UI.Input label="í˜‘ì˜ ë‚ ì§œ" type="date" value={form.date} onChange={e => setForm({...form, date: e.target.value})} /><div><label className="block text-xs font-bold text-gray-400 mb-2 ml-1">ì°¸ì„ì</label><div className="flex gap-3">{[{k:'parent', l:'ë³´í˜¸ì'}, {k:'special', l:'íŠ¹ìˆ˜êµì‚¬'}, {k:'homeroom', l:'ë‹´ì„êµì‚¬'}, {k:'vice', l:'êµê°'}].map(r => (<button key={r.k} onClick={() => toggleRole(r.l)} className={`px-3 py-2 rounded-lg text-sm font-bold border ${(form.attendees||'').includes(r.l) ? 'bg-blue-100 border-blue-300 text-blue-700' : 'bg-gray-50 border-gray-200 text-gray-400'}`}>{r.l}</button>))}</div></div></div>
        <div className="space-y-4 mb-6"><UI.Input label="ê°œë³„í™”êµìœ¡ ê³¼ëª©" value={form.subjects} onChange={e => setForm({...form, subjects: e.target.value})} placeholder="ì˜ˆ: êµ­ì–´, ìˆ˜í•™" /><div><label className="block text-xs font-bold text-gray-400 mb-1 ml-1">ğŸ¤ í–‰ë™ ì¤‘ì¬ ë° ì‹ ì²´ì  ê°œì… ë™ì˜</label><textarea lang="ko" value={form.agreement} onChange={e => setForm({...form, agreement: e.target.value})} className="w-full p-3 bg-red-50 border border-red-100 rounded-xl text-sm focus:ring-2 focus:ring-red-200 outline-none h-24 resize-none" placeholder="í˜‘ì˜ëœ ë™ì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”." /><div className="mt-2 flex flex-wrap gap-2"><span className="text-xs font-bold text-gray-400 flex items-center mr-1">âš¡ ìƒìš©êµ¬(í† ê¸€):</span>{BOILERPLATES.map((bp, idx) => { const isActive = form.agreement.includes(bp.text); return <button key={idx} onClick={() => toggleBoilerplate(bp.text)} className={`px-2 py-1 rounded text-xs font-bold transition-all ${isActive ? 'bg-green-500 text-white shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>{isActive ? 'âœ“ ' : ''}{bp.label}</button> })}</div></div></div>
        <div className="grid grid-cols-2 gap-6 h-64"><div className="flex flex-col"><label className="block text-xs font-bold text-gray-400 mb-1">ğŸ¤ íšŒì˜ë¡ ì›ë³¸ (Raw Data)</label><textarea lang="ko" value={form.original} onChange={e => setForm({...form, original: e.target.value})} className="flex-1 w-full p-3 bg-gray-50 border rounded-xl text-sm resize-none" placeholder="í´ë¡œë°”ë…¸íŠ¸ ê²°ê³¼ ë“±ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”." /></div><div className="flex flex-col relative"><label className="block text-xs font-bold text-gray-400 mb-1">ğŸ¤– AI ìš”ì•½ / ì •ë¦¬ë³¸</label><textarea lang="ko" value={form.summary} onChange={e => setForm({...form, summary: e.target.value})} className="flex-1 w-full p-3 bg-purple-50 border border-purple-100 rounded-xl text-sm resize-none" placeholder="AIê°€ ìš”ì•½í•œ ë‚´ìš©ì´ ì—¬ê¸°ì— ë“¤ì–´ê°‘ë‹ˆë‹¤." /><button onClick={handleAISummary} disabled={aiLoading} className={`absolute bottom-4 right-4 px-4 py-2 rounded-xl text-xs font-bold shadow-lg flex items-center gap-2 transition-all ${aiLoading ? 'bg-gray-400 text-white cursor-not-allowed' : 'bg-gradient-to-r from-blue-500 to-indigo-500 text-white hover:scale-105'}`}>{aiLoading ? <span className="animate-spin">âŒ›</span> : <Wand2 size={14}/>} {aiLoading ? 'ìš”ì•½ ì¤‘...' : 'Google AI ìë™ ìš”ì•½'}</button></div></div></div>
    </div>
  );
}